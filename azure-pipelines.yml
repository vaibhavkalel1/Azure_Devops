trigger:
  branches:
    include:
      - main

variables:
  azureSubscription: 'MyAzureServiceConnection'
  resourceGroup: 'rg-dev-vm'
  location: 'eastus'
  vmName: 'demo-vm'
  vmAdminUsername: 'azureuser'
  sshPublicKey: $(sshPublicKey)   # define this in pipeline as secret

stages:
  - stage: Deploy
    displayName: Deploy VM with NSG
    jobs:
      - job: Deploy
        displayName: 'Deploy Bicep Template'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - checkout: self

          - task: AzureCLI@2
            displayName: 'Create or Update Resource Group'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az group create --name $(resourceGroup) --location $(location)

          - task: AzureCLI@2
            displayName: 'Deploy Bicep Template'
            inputs:
              azureSubscription: $(azureSubscription)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az deployment group create \
                  --resource-group $(resourceGroup) \
                  --template-file bicep/main.bicep \
                  --parameters @bicep/parameters.dev.json \
                  --parameters \
                    vmAdminUsername=$(vmAdminUsername) \
                    sshPublicKey="$(sshPublicKey)"
